---
title: "Untitled"
format: html
---



# Introduction to Data Visualization with R

## Workshop Introduction

### Learning Objectives

The learning objectives for this workshp include:
- Use [`ggplot2`](https://ggplot2.tidyverse.org/) to create static graphs in R
- Use [`plotly`](https://plotly.com/r/getting-started/) R package to create interactive plots in R
- Use [`gt`](https://gt.rstudio.com/) R package to create tables in R.
- Learn enough data wrangling in R to facilitate creation of plots.

### Workshop outline

The outline of the workshop includes:

- Refresher of basic data visualization concepts
- static graphs with ggplot2
- Means and Distributions
    - One variable: histogram. Density plot. boxplot. Violin plot.
    - Two variables: bar plot w/ error bars. cleavland dot plot w/ error bars.
      - faceted histogram/density plot. faceted bar plot.
      - jittered boxplot/violin plot w/ transparency.
    - Three variables: Color, size & shape.
- Correlations:
  - Scatterplot

- Interactive plots with plotly: from ggplot2 to plotly 

Resources used in developing this workshop include the [Fundamentals of Data Visualization by Claus Wilke](https://clauswilke.com/dataviz/),[The R Graphics Cookbook by Winston Chang](https://r-graphics.org/), and [ggplot2 Elegant Graphics for Data Analysis (3e) by Wickham et al.](https://ggplot2-book.org/), 

### Types of Graphs
- Means and Distributions
    - One variable: histogram. Density plot. boxplot. Violin plot.
    - Two variables: bar plot w/ error bars. cleavland dot plot w/ error bars.
      - faceted histogram/density plot. faceted bar plot.
      - jittered boxplot/violin plot w/ transparency.
    - Three variables: Color, size & shape.
- Correlations:
  - Scatterplot
-

### R Programming Fundamentals

#### Installing and loading dependencies

By default, R has some packages loaded. These are packages in base R. We often want to add to R's functionality by installing and loading additional R packages.

- Installing means using the internet to download R packages we currently don't have, and putting them on our computer using `install.packages()`. They are not in R yet though, just downloaded to your computer.
  - It is the equivalent to downloading a pdf document from the internet but not opening it in a pdf editor.
- Loading means taking those downloaded packages and adding them to the current R session using `libarary()` or `require()`. We need to do this every time we start R.
  - This actually adds the ability to use a package's functions in R.


```{r}
#ggplot2 and tidyverse are already "installed" in google colab, so we just need to load them with library()
#install.packages("ggplot2")
library(ggplot2) #used for plotting
library(tidyverse) #a "universe" of data science R packages helpful for data reading and data wrangling.

#install plotly, gt, and ggpairs R packages. Takes about 2-3 minutes.
#install.packages("plotly")
#install.packages("gt")
#install.packages("GGally")

```

#### Assignment, Functions, & R Pipe.



### Foundational Graphing Concepts in R

#### The Grammar of Graphics

The grammar of graphics is a useful tool for understanding the layered nature of data visualization.
  
![](https://miro.medium.com/v2/resize:fit:4800/format:webp/1*ZdQ9wFwaA214ABiib7AygQ.png)


The basic format for ggplot2 is:
```
 ggplot(data = <DATA>,           #specify data
  mapping = aes(<MAPPINGS>)) +   #add global aesthetic mappings
  <GEOM_FUNCTION>()              #specify shapes used.

 ```
Where `<DATA>` is long-format data, `<MAPPINGS>` are the aesthetic mappings that link variables to X, and `<GEOM_FUNCTION>()` specifies the shapes used to represent the data, and `+` is used to .


```{r}
#check structure of the dataset
str(diamonds)

#using ggplot() creates the canvas we'll be using.
 #inform ggplot we're using "diamonds" dataframe
ggplot(data = diamonds)

#specifying the aesthetic mappings adds ...
 #define an aesthetic mapping (using the aesthetic (aes) function)
 #specify variables to be plotted and how to present them
 #e.g., x axis, y axis, colour, size, etc.
ggplot(data = diamonds,                           #use diamonds dataframe
  mapping = aes(x=carat, y=price, color = cut))   #carat on x axis. Price on y.

ggplot(data = diamonds,                           #use diamonds dataframe
  mapping = aes(x=mean(carat), color = cut)) +
    geom_dot()

#adding 'geoms': graphical representation of data.
 #e.g., points, lines, bars
 ggplot(data = diamonds,                           #use diamonds dataframe
  mapping = aes(x=carat, y=price, color = cut)) +  #carat on x axis. Price on y.
    geom_point()                                   #use points (dots)

```
### Exploratory Data Analysis
- ggpairs
-

```{r}

#Generalized Pairs Plot
mtcars_subset <- mtcars |> dplyr::select(where(is.numeric))

p <- GGally::ggpairs(mtcars,
lower=list(combo=GGally::wrap("facethist", bins=6))) +
ggtitle("Assoc. among car MPG, displacement,\ntransmission, and num gears") +
theme_bw(base_size=16) + labs(x=NULL, y=NULL)
p


```

### Common Idioms:

- Scatterplot: 2 continuous variables (correlation)
- Bar chart: 1+ key variables, 1 continuous (relative magnitude)
- Stacked bar chart: 1+ key variables, 1 continuous (part-to-whole)
- Histogram: 1+ key variables, 1 continuous (derived from binning data)
- Line chart (dot plot): 1 ordered key, 1 continuous (trends, ranks)
- Boxplot: 1+ key variables, 1 continuous variable (univariate distributions, outliers)
- Heatmap: 2 key variables, 1 continuous (clusters, outliers)
- Scatterplot matrix: multivariate continuous (correlation, outliers)

Idioms with aggregation:
- Histogram
- Frequency polygon
- Violin plot
- Box plot


```{r}
#idiom: scatterplot.
 #two continuous variables
p <- diamonds %>%
ggplot(aes(x=carat, y=price)) +
geom_point(size=1.8) +
labs(title="Price of diamond") +
theme_bw(base_size = 18)
p
#can add colour or shape

```

```{r}
#Scatterplot w/ histogram
# install.packages("ggplot2")
# install.packages("ggExtra")
library(ggplot2)
library(ggExtra)

# Save the scatter plot in a variable
p <- ggplot(cars, aes(x = speed, y = dist)) +
  geom_point()

# Changing the relative size
ggMarginal(p, type = "histogram",
           size = 3)

```

 ```{r}

#histogram
p <- cars %>%
ggplot(aes(x=dist)) +
geom_histogram(binwidth=25, fill="grey", color="black") +
labs(title="Price of book", subtitle="Bin size = 25") +
theme_bw(base_size = 18)
p

```
```{r}
#Bar chart
 #1 categorical, 1 continuous
p <- diamonds %>%
ggplot(aes(x=clarity, y=price)) +
stat_summary(fun="mean",geom="bar", size=1.5) + #geom_bar()
labs(title="Mean price of diamond by clarity") +
theme_bw(base_size = 18)
p
```

```{r}
#stacked bar chart
 #to add
 ```



```{r}
#lollipop plot
p <- data %>%
arrange(value) %>% # First sort by val. This sorts the dataframe but NOT
the factor levels
mutate(name=factor(name, levels=name)) %>% # This trick updates the
factor levels
ggplot(aes(x=name, y=value)) +
geom_segment(aes(xend=name, yend=0)) +
geom_point(size=4, color="orange") +
coord_flip() + theme_bw(base_size = 24) + xlab("")

```

```{r}

#line chart
p <- ggplot(bitcoin, aes(x=Date, y=Close)) +
geom_line(size=1.5) + theme_bw(base_size=24) +
labs(title="Bitcoin prices over the past 12 months", y="Closing price
(USD)") +
theme(axis.text.x = element_text(angle=45, hjust=0.9))
```

```{r}
#bar plot
p <- bfi %>%
ggplot(aes(x=education, y=otot)) +
geom_boxplot() +
labs(title="BFI openness to experience", subtitle="split by education
level") +
coord_flip() +
theme_bw(base_size = 24) + theme(panel.grid.major.x = element_blank())
```

```{r}

#Heatmap
p <- ggplot(volcano_df, aes(x=East_West, y=North_South, fill=Height)) +
geom_tile() + coord_fixed() + scale_fill_viridis_c(option="inferno") +
labs(x="East - West position", y="North - South position", title="Height of
Mt. Eden (Auckland)")
plot(p)

```

```{r}
#Scatterplot matrix
p <- ggscatmat(mtcars %>% select(mpg, disp, hp, wt)) +
ggtitle("Assoc. among car MPG, displacement,\nhorsepower, and weight") +
theme_bw(base_size=18) + labs(x=NULL, y=NULL)
```

```
#to-do: use correlation::correlation() and see from easystats R ecosystem.
```

```{r}

#normalized stacked bar chart
p <- diamonds %>%
ggplot(aes(x=cut, fill=color)) +
geom_histogram(stat="count", position="fill") +
labs(title="Number of diamonds by cut and color") +
theme_bw(base_size = 18) + ylab("Proportion")
```

```
#parallel coordinates plot
 #3.31
 ```

```{r}

# density plots aka Frequency Polygon
p <- diamonds %>%
ggplot(aes(x=price, color=clarity)) +
geom_density(size=1.8) +
labs(title="Price of diamond", subtitle="color denotes clarity") +
theme_bw(base_size = 18)
p
```

```{r}
#pie chart
dcount <- diamonds %>% group_by(color) %>% tally()
p <- dcount %>%
ggplot(aes(x="", y=n, fill=color)) +
geom_bar(stat="identity", width=1) +
coord_polar("y") +
labs(title="Number of diamonds by cut and color") +
theme_void(base_size = 18)
p
```

```{r}
#bar plot and facet wrap
#
ggplot(bfi_long,
aes(x=response)) +
geom_bar(stat = "count") +
facet_wrap(~item)
```


## Interactive Plots with Plotly

See https://plotly.com/ggplot2/.
Can convert some ggplot2 objects to plotly objects with `plotly::ggplotly()`. For example, scatterplot.
```{r}

library(plotly)
library(dplyr)
library(gapminder)

#clean data
data <- gapminder %>% 
filter(year=="2007") %>% 
dplyr::select(-year)

#create ggplot2 graph
p <- ggplot(data, 
aes(x=gdpPercap, y=lifeExp, size = pop)) +
              geom_point(alpha=0.7)

#convert ggplot2 graph to interactive plotly object
ggplotly(p)

```

Can do the same with fancier bubbleplot:

```{r}
library(plotly)
library(dplyr)
library(gapminder)

data <- gapminder %>% filter(year=="2007") %>% dplyr::select(-year)

# Most basic bubble plot
p <- data %>%
      arrange(desc(pop)) %>%
      mutate(country = factor(country, country)) %>%
      ggplot(aes(x=gdpPercap, y=lifeExp, size=pop, color=continent)) +
        geom_point(alpha=0.5) +
        scale_size(range = c(.1, 24), name="Population (M)")

ggplotly(p)
data <- gapminder %>% filter(year=="2007") %>% dplyr::select(-year)

# Most basic bubble plot
p <- data %>%
      arrange(desc(pop)) %>%
      mutate(country = factor(country, country)) %>%
      ggplot(aes(x=gdpPercap, y=lifeExp, size=pop, color=continent)) +
        geom_point(alpha=0.5) +
        scale_size(range = c(.1, 24), name="Population (M)")

ggplotly(p)
```

Can do similar with boxplot instead:

```{r}

set.seed(1234)
dat <- data.frame(cond = factor(rep(c("A","B"), each=200)), rating = c(rnorm(200),rnorm(200, mean=.8)))

p <- ggplot(dat, aes(x=cond, y=rating, fill=cond)) + geom_boxplot()

ggplotly(p)

```

Can do similar with histogram and density plot

```{r}
library(plotly)

df <- data.frame (type=rep(1:2, each=1000), subtype=rep(c("a","b"), each=500), value=rnorm(4000, 0,1))

library(plyr)
df.text<-ddply(df,.(type,subtype),summarise,mean.value=mean(value))

p <- ggplot(df, aes(x=value, fill=subtype)) +
    geom_histogram(position="identity", alpha=0.4)+
    facet_grid(. ~ type)

ggplotly(p)

```

Can turn `GGally::ggpairs()` into plotly graph as well [see here](https://plotly-r.com/arranging-views)

```{r}
pm <- GGally::ggpairs(iris, aes(color = Species))
class(pm)
#> [1] "gg"  "ggmatrix"
ggplotly(pm)
```

Can combine multiple plotly plots with `plotly::subplot()`: https://plotly-r.com/arranging-views 


### Animated graphs with ggplotly
See https://plotly-r.com/animating-views.html and https://plotly.com/ggplot2/animations/
Can make animation with ggplotly by specifying a frame variable within ggplot2. Then `plotly::ggplotly()`
```{r}
library(plotly)
library(ggplot2)
library(gapminder)


p <- ggplot(gapminder, aes(gdpPercap, lifeExp, color = continent)) +
  geom_point(aes(size = pop, frame = year, ids = country)) +
  scale_x_log10()

fig <- ggplotly(p)
fig
```

Can subsequently add animation options, button options, and slider options.

Animation options:

```{r}
#specify animation options
fig %>% 
  animation_opts(
    1000, easing = "elastic", redraw = FALSE
  )


```

Button options:
```{r}
fig %>% 
  animation_button(
    x = 1, xanchor = "right", y = 0, yanchor = "bottom"
  ) 
  ```

Slider options:
  ```{r}
  
  fig %>%
  animation_slider(
    currentvalue = list(prefix = "YEAR ", font = list(color="red"))
  )

fig
```

Can then put it all together:

```{r}
library(plotly)
library(ggplot2)
library(gapminder)

p <- ggplot(gapminder, aes(gdpPercap, lifeExp, color = continent)) +
  geom_point(aes(size = pop, frame = year, ids = country)) +
  scale_x_log10()

fig <- ggplotly(p) %>% 
  animation_opts(
    1000, easing = "elastic", redraw = FALSE
  ) %>% 
  animation_button(
    x = 1, xanchor = "right", y = 0, yanchor = "bottom"
  ) %>%
  animation_slider(
    currentvalue = list(prefix = "YEAR ", font = list(color="red"))
  )

fig

```


## Making Tables with gt R package
```{r}
#testing gt functionality in jupyter notebook.
gt_tab <- ggplot2::diamonds |> dplyr::count(cut) |> gt::gt()

#workaround so gt plays nice with jupyter notebooks.
gts <- function(gt_table){
   gt:::as.tags.gt_tbl(gt_table)
}
gts(gt_tab)
```